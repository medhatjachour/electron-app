name: Build Windows Executable

on:
  push:
    branches:
      - main
      - release/*
    tags:
      - 'v*.*.*'
  pull_request:
    branches:
      - main
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (optional)'
        required: false
        type: string

jobs:
  build-windows:
    runs-on: windows-latest
    
    strategy:
      matrix:
        node-version: [18.x]
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Generate Prisma Client
        run: npx prisma generate
      
      - name: Verify Prisma binaries
        run: |
          Write-Host "Checking generated Prisma binaries..."
          Get-ChildItem -Path "src/generated/prisma" -Filter "*.node" -Recurse | ForEach-Object {
            Write-Host "Found: $($_.Name) - $([math]::Round($_.Length/1MB, 2)) MB"
          }
          if (!(Test-Path "src/generated/prisma/query_engine-windows.dll.node")) {
            Write-Error "Windows Prisma binary not found!"
            exit 1
          }
          Write-Host "✓ Windows Prisma binary verified"
        shell: pwsh
      
      - name: Prepare template database
        run: |
          Write-Host "Creating fresh template database..."
          if (Test-Path "prisma/template.db") {
            Remove-Item "prisma/template.db" -Force
            Write-Host "Removed existing template database"
          }
          
          # Set DATABASE_URL to create template in prisma folder
          $env:DATABASE_URL = "file:./prisma/template.db"
          
          Write-Host "Running Prisma migrations..."
          npx prisma migrate deploy
          
          Write-Host "Seeding database..."
          npx prisma db seed
          
          # Verify template database was created
          if (Test-Path "prisma/template.db") {
            $size = (Get-Item "prisma/template.db").Length / 1KB
            Write-Host "✓ Template database created successfully: $([math]::Round($size, 2)) KB"
          } else {
            Write-Host "❌ Template database not found in expected location!"
            Write-Host "Checking current directory..."
            if (Test-Path "template.db") {
              Write-Host "Found template.db in root, moving to prisma folder..."
              Move-Item "template.db" "prisma/template.db" -Force
              $size = (Get-Item "prisma/template.db").Length / 1KB
              Write-Host "✓ Template database moved: $([math]::Round($size, 2)) KB"
            } else {
              Write-Error "Failed to create template database!"
              exit 1
            }
          }
        shell: pwsh
      
      - name: Build application
        run: npm run build
        env:
          NODE_ENV: production
      
      - name: Package Windows installer
        run: npm run build:win
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Get version from package.json
        id: package-version
        run: |
          $version = node -p "require('./package.json').version"
          echo "version=$version" >> $env:GITHUB_OUTPUT
        shell: pwsh
      
      - name: List build artifacts
        run: |
          Write-Host "Build artifacts in dist folder:"
          Get-ChildItem -Path dist -Recurse -File | Select-Object Name, Length, LastWriteTime
        shell: pwsh
      
      - name: Upload Windows installer
        uses: actions/upload-artifact@v4
        with:
          name: BizFlow-Windows-Setup-${{ steps.package-version.outputs.version }}
          path: |
            dist/*.exe
            dist/*.exe.blockmap
          retention-days: 30
          if-no-files-found: error
      
      - name: Upload Windows portable
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: BizFlow-Windows-Portable-${{ steps.package-version.outputs.version }}
          path: dist/*.zip
          retention-days: 30
          if-no-files-found: warn
      
      - name: Create Release (on tag)
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            dist/*.exe
            dist/*.exe.blockmap
            dist/*.zip
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Optional: Build for multiple architectures
  build-windows-multi-arch:
    runs-on: windows-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    strategy:
      matrix:
        arch: [x64, ia32, arm64]
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18.x
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Generate Prisma Client
        run: npx prisma generate
      
      - name: Verify Prisma binaries
        run: |
          Write-Host "Verifying Windows Prisma binary..."
          if (Test-Path "src/generated/prisma/query_engine-windows.dll.node") {
            Write-Host "✓ Windows Prisma binary found"
          } else {
            Write-Error "Windows Prisma binary not found!"
            exit 1
          }
        shell: pwsh
      
      - name: Prepare template database
        run: |
          if (!(Test-Path "prisma/template.db")) {
            npx prisma migrate deploy
            npx prisma db seed
          }
        shell: pwsh
      
      - name: Build application
        run: npm run build
      
      - name: Package Windows installer (${{ matrix.arch }})
        run: npm run build:win -- --${{ matrix.arch }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Upload artifacts (${{ matrix.arch }})
        uses: actions/upload-artifact@v4
        with:
          name: BizFlow-Windows-${{ matrix.arch }}
          path: dist/*.exe
          retention-days: 30
